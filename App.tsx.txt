
import React, { useState, useEffect } from 'react';
import { Conversation, Message, Mode } from './types.ts';
import { gemini } from './services/geminiService.ts';
import Sidebar from './components/Sidebar.tsx';
import ChatArea from './components/ChatArea.tsx';
import OwnerModal from './components/OwnerModal.tsx';

const HISTORY_KEY = 'ramzz_ultra_final_history';

// Helper untuk ID unik tanpa perlu library luar
const generateId = () => crypto.randomUUID?.() || Math.random().toString(36).substring(2, 15);

const App: React.FC = () => {
  const [conversations, setConversations] = useState<Conversation[]>([]);
  const [activeId, setActiveId] = useState<string | null>(null);
  const [mode, setMode] = useState<Mode>('standard');
  const [isTyping, setIsTyping] = useState(false);
  const [showOwnerModal, setShowOwnerModal] = useState(false);
  const [isLoaded, setIsLoaded] = useState(false);

  useEffect(() => {
    const saved = localStorage.getItem(HISTORY_KEY);
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed) && parsed.length > 0) {
          setConversations(parsed);
          setActiveId(parsed[0].id);
        }
      } catch (e) { 
        console.error("Local storage fail", e); 
      }
    }
    setIsLoaded(true);
  }, []);

  useEffect(() => {
    if (isLoaded) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(conversations));
    }
  }, [conversations, isLoaded]);

  const handleSendMessage = async (content: string) => {
    if (!content.trim() || isTyping) return;

    let currentId = activeId;
    
    // Jika tidak ada chat aktif, buat baru
    if (!currentId) {
      currentId = generateId();
      const newConv: Conversation = { 
        id: currentId, 
        title: content.slice(0, 30), 
        messages: [], 
        createdAt: Date.now() 
      };
      setConversations(prev => [newConv, ...prev]);
      setActiveId(currentId);
    }

    const userMsg: Message = { role: 'user', content, timestamp: Date.now() };
    
    setConversations(prev => prev.map(c => 
      c.id === currentId 
        ? { 
            ...c, 
            messages: [...c.messages, userMsg], 
            title: c.messages.length === 0 ? content.slice(0, 30) : c.title 
          } 
        : c
    ));

    setIsTyping(true);

    try {
      const activeConv = conversations.find(c => c.id === currentId);
      // Kirim history agar AI punya ingatan (memory)
      const history = activeConv ? [...activeConv.messages, userMsg] : [userMsg];
      
      const response = await gemini.generateResponse(history, mode);
      const aiMsg: Message = { role: 'model', content: response, timestamp: Date.now() };

      setConversations(prev => prev.map(c => 
        c.id === currentId ? { ...c, messages: [...c.messages, aiMsg] } : c
      ));
    } catch (err) {
      console.error("Ramzz Process Error:", err);
    } finally {
      setIsTyping(false);
    }
  };

  if (!isLoaded) return null;

  return (
    <div className="flex h-screen w-full bg-luxury text-white overflow-hidden animate-fade-in">
      <Sidebar 
        conversations={conversations} 
        activeId={activeId} 
        onSelect={setActiveId} 
        onDelete={id => {
          setConversations(prev => prev.filter(c => c.id !== id));
          if (activeId === id) setActiveId(null);
        }}
        onNewChat={() => {
          const id = generateId();
          setConversations(prev => [{ id, title: 'Chat Baru', messages: [], createdAt: Date.now() }, ...prev]);
          setActiveId(id);
        }}
      />

      <main className="flex-1 flex flex-col relative overflow-hidden h-full">
        <header className="glass-panel px-6 md:px-10 py-5 border-b border-white/5 flex items-center justify-between z-40">
          <div className="flex items-center gap-4">
            <h1 className="text-2xl md:text-3xl font-black tracking-tighter bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500 bg-clip-text text-transparent">RAMZZ.AI</h1>
            {mode === 'owner' && <span className="bg-gold text-black text-[8px] md:text-[9px] font-black px-3 py-1 rounded-full shadow-lg shadow-gold/20 tracking-widest uppercase">Owner Mode</span>}
          </div>
          <button 
            onClick={() => mode === 'owner' ? setMode('standard') : setShowOwnerModal(true)} 
            className={`px-6 md:px-8 py-2 md:py-2.5 rounded-2xl text-[9px] font-black uppercase tracking-[0.2em] transition-all transform active:scale-95 ${mode === 'owner' ? 'bg-gold text-black shadow-gold/20' : 'bg-white/5 text-slate-400 hover:bg-white/10 hover:text-white'}`}
          >
            {mode === 'owner' ? 'Exit Master' : 'Owner Access'}
          </button>
        </header>

        <ChatArea 
          messages={conversations.find(c => c.id === activeId)?.messages || []} 
          isTyping={isTyping} 
          onSendMessage={handleSendMessage} 
          mode={mode} 
        />

        {showOwnerModal && (
          <OwnerModal 
            onClose={() => setShowOwnerModal(false)} 
            onSuccess={() => { setMode('owner'); setShowOwnerModal(false); }} 
          />
        )}
      </main>
    </div>
  );
};

export default App;
